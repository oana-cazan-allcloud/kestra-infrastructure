volumes:
  postgres-data:
    driver: local
  kestra-data:
    driver: local
  git-flows:
    driver: local
  repo-watch:
    driver: local

services:
  postgres:
    image: postgres:17
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 10

  kestra:
    image: kestra/kestra:latest
    pull_policy: always
    user: "root"
    command: server standalone --no-tutorials
    volumes:
      - kestra-data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
      - repo-watch:/repo
    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            basicAuth:
              username: ${KESTRA_BASIC_AUTH_USERNAME} # it must be a valid email address
              password: ${KESTRA_BASIC_AUTH_PASSWORD} # it must be at least 8 characters long with uppercase letter and a number
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
        micronaut:
          io:
            watch:
              enabled: true
              paths:
                - /repo/_flows
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_started
      repo-syncer:
        condition: service_started

  git-sync:
    image: registry.k8s.io/git-sync/git-sync:v4.4.2
    container_name: kestra-git-sync
    user: "root"
    environment:
      GITSYNC_REPO: git@github.com:oana-cazan-allcloud/cargo-partners.git
      GITSYNC_ROOT: /git
      GITSYNC_LINK: cargo-partners
      GITSYNC_PERIOD: 10s
      GITSYNC_REF: main
      GITSYNC_ONE_TIME: "false"
      GITSYNC_MAX_FAILURES: -1
      GITSYNC_SSH_KEY_FILE: /etc/git-secret/ssh
      GITSYNC_SSH_KNOWN_HOSTS: "true"
      GITSYNC_SSH_KNOWN_HOSTS_FILE: /etc/git-secret/known_hosts
      GITSYNC_ADD_USER: "true"
    volumes:
      - git-flows:/git
      - ~/.ssh/id_ed25519:/etc/git-secret/ssh:ro
      - ~/.ssh/known_hosts:/etc/git-secret/known_hosts:ro

  repo-syncer:
    image: alpine:3.18
    container_name: kestra-repo-syncer
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache rsync inotify-tools
        echo 'Repo syncer started (inotify mode)...'
        
        # Initial sync
        if [ -d /git/cargo-partners/_flows ]; then
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Initial sync..."
          rsync -a --delete --exclude='.git' --exclude='.gitignore' /git/cargo-partners/_flows/ /repo/_flows/
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Initial sync complete"
        fi
        
        # Watch for changes and sync only when needed
        while true; do
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Watching for changes in /git/cargo-partners/_flows..."
          
          # inotifywait blocks until a change occurs (efficient!)
          inotifywait -r -e modify,create,delete,move /git/cargo-partners 2>/dev/null
          
          # Give git-sync a moment to finish writing (debounce)
          sleep 2
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Change detected, syncing..."
          rsync -a --delete --exclude='.git' --exclude='.gitignore' /git/cargo-partners/_flows/ /repo/_flows/
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Sync complete"
        done
    volumes:
      - git-flows:/git:ro
      - repo-watch:/repo
    depends_on:
      - git-sync
    restart: unless-stopped