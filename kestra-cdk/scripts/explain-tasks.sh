#!/bin/bash
# Explain why tasks aren't running and how to fix it

echo "ğŸ“š Understanding: Why Tasks Aren't Running"
echo "==========================================="
echo ""
echo "In AWS ECS, here's how it works:"
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ 1. Task Definition (Blueprint)                 â”‚"
echo "â”‚    Created by: KestraEcsTaskStack             â”‚"
echo "â”‚    Defines: containers, CPU, memory, etc.     â”‚"
echo "â”‚    Status: Just a template, doesn't run       â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                    â†“"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ 2. ECS Service (Task Manager)                   â”‚"
echo "â”‚    Created by: KestraEcsServiceStack            â”‚"
echo "â”‚    Uses: Task Definition                        â”‚"
echo "â”‚    Does: Creates and manages tasks              â”‚"
echo "â”‚    Keeps: desiredCount tasks running            â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                    â†“"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ 3. Tasks (Running Containers)                   â”‚"
echo "â”‚    Created by: ECS Service                      â”‚"
echo "â”‚    Uses: Task Definition                        â”‚"
echo "â”‚    Status: Actual running containers            â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ Common Misconception:"
echo "   'Tasks' are NOT a separate stack!"
echo "   Tasks are created AUTOMATICALLY by the Service"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ” Why Tasks Might Not Be Running:"
echo ""
echo "1. Service Not Deployed"
echo "   â†’ Deploy: npx cdk deploy KestraEcsServiceStack"
echo "   â†’ Without service, no tasks will be created"
echo ""
echo "2. Service Deployed But Tasks Failing"
echo "   â†’ Check service events for errors"
echo "   â†’ Tasks start but immediately stop"
echo "   â†’ Common causes:"
echo "     â€¢ Secrets not accessible"
echo "     â€¢ EFS mount issues"
echo "     â€¢ Container health check failing"
echo "     â€¢ Insufficient resources"
echo ""
echo "3. Service Deployed But desiredCount = 0"
echo "   â†’ Service exists but not starting tasks"
echo "   â†’ Check service configuration"
echo ""
echo "4. Tasks Starting But Stopping Immediately"
echo "   â†’ Check CloudWatch logs"
echo "   â†’ Check container exit codes"
echo "   â†’ Review service events"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… To Get Tasks Running:"
echo ""
echo "Step 1: Ensure Task Definition exists"
echo "   npx cdk deploy KestraEcsTaskStack"
echo ""
echo "Step 2: Deploy the Service (THIS CREATES TASKS)"
echo "   npx cdk deploy KestraEcsServiceStack"
echo ""
echo "Step 3: Service will automatically create tasks"
echo "   â†’ Service reads desiredCount (currently set to 1)"
echo "   â†’ Service uses Task Definition to create tasks"
echo "   â†’ Tasks start running"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ Key Point:"
echo "   You don't 'deploy tasks' separately"
echo "   You deploy the SERVICE, and it creates tasks"
echo ""
echo "   Task Definition = Recipe"
echo "   Service = Chef (creates tasks from recipe)"
echo "   Tasks = The dishes (created automatically)"

